# EXE文件加密分发系统 - 完整使用指南

本系统实现了**一人一码**的EXE文件加密分发方案，支持云盘直链下载、自动化下载脚本和本地密钥验证。

---

## 📋 目录结构

```
Release/
├── tools/                          # 管理工具(管理员使用)
│   ├── encrypt_exe.py             # EXE加密工具
│   ├── generate_keys.py           # 密钥生成器
│   ├── requirements.txt           # Python依赖
│   ├── user_keys.json            # 用户密钥数据库(自动生成)
│   └── keys_export.txt           # 导出的密钥列表(可选)
│
├── dist/                          # 分发文件(给用户)
│   ├── download.bat              # 自动下载脚本
│   ├── launcher.py               # 启动器源码
│   ├── launcher.exe              # 启动器程序(需编译)
│   └── build_launcher.txt        # 编译说明
│
└── README.md                     # 本文档
```

---

## 🚀 快速开始

### 第一步: 环境准备

1. **安装Python 3.8+**
   ```bash
   python --version  # 检查版本
   ```

2. **安装依赖包**
   ```bash
   cd tools
   pip install -r requirements.txt
   ```

---

## 📦 管理员操作流程

### 1. 加密EXE文件

```bash
cd tools
python encrypt_exe.py
```

**操作步骤:**
1. 输入原始EXE文件路径
2. 程序自动生成:
   - `程序名_encrypted.dat` - 加密后的文件(上传到云盘)
   - `程序名_master.key` - 主密钥文件(**重要!请妥善保管**)

**示例:**
```
请输入原始EXE文件路径: C:\MyProgram.exe

[*] 正在读取文件: C:\MyProgram.exe
[*] 文件大小: 5242880 字节
[*] 生成主密钥...
[*] 开始加密...
[✓] 加密完成: MyProgram_encrypted.dat
[✓] 加密文件大小: 5242896 字节
[✓] 主密钥已保存到: MyProgram_master.key
```

---

### 2. 上传加密文件到云盘

#### 方案A: 阿里云OSS (推荐)

**优势:** 稳定、快速、可控制有效期

1. **创建OSS Bucket**
   - 登录阿里云控制台
   - 创建标准存储Bucket
   - 设置为私有访问

2. **上传文件**
   - 上传 `程序名_encrypted.dat`
   - 点击"获取URL"
   - 选择"签名URL"
   - 设置有效期(如: 365天)

3. **获取直链**
   ```
   https://your-bucket.oss-cn-hangzhou.aliyuncs.com/program_encrypted.dat?Expires=xxx&OSSAccessKeyId=xxx&Signature=xxx
   ```

#### 方案B: 蓝奏云

1. 上传文件到蓝奏云
2. 获取分享链接
3. 使用工具转换为直链:
   - https://api.lanzoux.com/xxxxx (分享链接)
   - https://xxx.lanzoux.com/xxxxx (直链)

#### 方案C: 百度网盘

1. 上传文件
2. 使用第三方工具获取直链(如: PanDownload API)
3. 注意: 百度网盘可能限速

---

### 3. 生成用户密钥

```bash
cd tools
python generate_keys.py
```

**操作步骤:**

1. 输入主密钥文件路径: `MyProgram_master.key`

2. 选择操作:
   - **选项1: 生成单个用户密钥**
     ```
     用户ID: USER001
     用户姓名: 张三
     备注信息: VIP用户

     激活密钥: a1b2c3d4e5f6....(64位十六进制)
     ```

   - **选项2: 批量生成密钥**
     ```
     USER001,张三,VIP用户
     USER002,李四,普通用户
     USER003,王五,试用用户
     (输入空行结束)
     ```

   - **选项3: 查看已生成的密钥**
   - **选项4: 导出密钥到文件**
     - 生成 `keys_export.txt`

3. 将密钥发送给对应用户

---

### 4. 准备分发文件

#### 4.1 配置下载脚本

编辑 `dist/download.bat`，修改以下内容:

```batch
REM 云盘直链地址
set "DOWNLOAD_URL=https://your-actual-download-url.com/program_encrypted.dat"

REM 下载后的文件名
set "OUTPUT_FILE=program_encrypted.dat"
```

#### 4.2 编译启动器

```bash
cd dist
pip install pyinstaller pycryptodome
pyinstaller --onefile --windowed --name=launcher launcher.py
```

编译后，`launcher.exe` 位于 `dist/dist/launcher.exe`

#### 4.3 打包给用户

将以下文件打包成ZIP:
```
用户安装包/
├── download.bat          # 下载脚本
├── launcher.exe          # 启动器
└── 使用说明.txt          # 简单说明
```

---

## 👤 用户使用流程

### 1. 下载程序文件

1. 双击运行 `download.bat`
2. 脚本自动检测下载工具(curl/PowerShell/wget)
3. 从云盘下载加密文件
4. 下载完成后提示是否立即启动

**预期输出:**
```
====================================================================
                    程序自动下载工具
====================================================================

[1/4] 检测下载工具...
[✓] 检测到 curl 工具

[2/4] 开始下载文件...
下载地址: https://...
保存为: program_encrypted.dat
[*] 使用 curl 下载...
######################################################################## 100.0%
[✓] 下载成功! 文件大小: 5242896 字节

[3/4] 检查启动器...
[✓] 启动器就绪

[4/4] 准备启动程序...
====================================================================
[✓] 所有准备工作已完成!
====================================================================

是否现在启动程序? (Y/N):
```

---

### 2. 启动并验证

1. 运行 `launcher.exe`
2. 弹出图形界面
3. 输入64位激活密钥
4. 点击"验证并启动"

**验证流程:**
- ✅ 密钥格式检查(64位十六进制)
- ✅ 解密文件验证
- ✅ PE头验证(确保是有效的EXE)
- ✅ 创建临时文件并运行

**成功后:** 原程序自动启动，启动器关闭

**失败提示:**
- "密钥格式错误" - 密钥不是64位十六进制
- "密钥无效或已过期" - 密钥错误
- "未找到加密文件" - 需先运行下载脚本

---

## 🔐 安全特性

### 一人一码机制

每个用户的密钥生成算法:
```
用户密钥 = SHA256(主密钥 + 用户ID + 随机盐 + 时间戳)
```

**特点:**
- ✅ 每个用户的密钥完全独立
- ✅ 无法从一个密钥推导出其他密钥
- ✅ 可追踪密钥使用情况
- ✅ 可单独撤销某个用户的访问权限

### 加密方案

- **算法:** AES-256-CBC
- **密钥长度:** 256位
- **模式:** CBC (密码块链接模式)
- **填充:** PKCS7

### 防破解措施

1. **加密文件不包含主密钥** - 即使获取加密文件也无法解密
2. **本地验证** - 无需联网，防止中间人攻击
3. **临时运行** - 解密后的EXE存储在临时目录，程序关闭后自动清理
4. **PE头验证** - 防止恶意密钥导致运行非法程序

---

## 🛠️ 高级功能

### 密钥有效期管理

如需实现密钥有效期，可修改 `generate_keys.py`:

```python
import time

def generate_key_with_expiry(user_id, days_valid=365):
    expiry_timestamp = int(time.time()) + (days_valid * 86400)
    key_material = f"{user_id}:{expiry_timestamp}"
    return hashlib.sha256(key_material.encode()).hexdigest()
```

### 使用次数限制

可在 `launcher.py` 中添加:

```python
def check_usage_count(user_key):
    count_file = f"{user_key[:8]}.count"
    if os.path.exists(count_file):
        with open(count_file, 'r') as f:
            count = int(f.read())
        if count >= MAX_USAGE:
            return False
        count += 1
    else:
        count = 1

    with open(count_file, 'w') as f:
        f.write(str(count))
    return True
```

### 硬件绑定

绑定到机器码:

```python
import uuid

def get_machine_id():
    return str(uuid.getnode())

def verify_with_machine_id(user_key):
    machine_id = get_machine_id()
    combined = f"{user_key}:{machine_id}"
    return hashlib.sha256(combined.encode()).hexdigest()
```

---

## 📝 注意事项

### 管理员必读

1. **主密钥文件安全**
   - `程序名_master.key` 是核心文件
   - 丢失后无法生成新的有效密钥
   - 泄露后所有密钥失效
   - 建议加密存储或保存在安全位置

2. **密钥数据库**
   - `user_keys.json` 记录所有已生成的密钥
   - 可用于密钥管理和撤销
   - 建议定期备份

3. **云盘链接管理**
   - 使用带签名的临时URL增加安全性
   - 定期更换下载链接
   - 监控下载次数防止滥用

### 用户须知

1. **密钥保管**
   - 密钥仅供个人使用
   - 不要分享给他人
   - 如密钥泄露请联系管理员

2. **系统要求**
   - Windows 7 及以上
   - 需要联网下载文件
   - 首次运行需要下载加密文件

3. **杀毒软件**
   - 启动器可能被误报为病毒(因为解密执行)
   - 请添加到白名单

---

## 🔧 故障排除

### 常见问题

**Q1: 下载失败怎么办?**
- 检查网络连接
- 确认云盘链接是否有效
- 尝试手动下载链接测试

**Q2: 密钥验证失败?**
- 确认密钥是64位十六进制字符
- 检查是否复制完整(无空格/换行)
- 联系管理员确认密钥有效性

**Q3: 程序无法启动?**
- 确认 `program_encrypted.dat` 已下载
- 检查杀毒软件是否拦截
- 查看 Windows 事件查看器中的错误日志

**Q4: launcher.exe 编译失败?**
- 确认已安装所有依赖: `pip install pyinstaller pycryptodome`
- Python版本 >= 3.8
- Windows系统需要安装 Visual C++ 运行库

**Q5: 启动器被杀毒软件删除?**
- 这是正常现象(解密执行行为被误判)
- 添加到杀毒软件白名单
- 或使用数字签名证书签名launcher.exe

---

## 📊 工作流程图

```
管理员流程:
┌─────────────────┐
│  原始 EXE 文件   │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  encrypt_exe.py │ ──→ 生成主密钥文件
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│   加密 DAT 文件  │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  上传到云盘平台  │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  获取直链地址    │
└────────┬────────┘
         │
         ▼
┌──────────────────┐
│ generate_keys.py │ ──→ 生成用户密钥
└────────┬─────────┘
         │
         ▼
┌─────────────────┐
│  分发密钥给用户  │
└─────────────────┘

用户流程:
┌─────────────────┐
│  获取安装包      │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  运行 download.bat│
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  下载加密文件    │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  运行 launcher.exe│
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  输入64位密钥    │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  验证并解密      │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  程序自动运行    │
└─────────────────┘
```

---

## 📞 技术支持

如有问题，请联系技术支持，提供以下信息:
- 用户ID
- 错误截图
- 操作系统版本
- 问题详细描述

---

## 📄 许可证

本系统仅供内部使用，未经授权不得擅自修改或分发。

---

## 🎯 总结

本系统提供了完整的EXE文件加密分发解决方案:

✅ **一人一码** - 每个用户独立密钥
✅ **云盘分发** - 支持多种云存储平台
✅ **自动下载** - BAT脚本自动化操作
✅ **本地验证** - 无需联网验证，保护隐私
✅ **安全加密** - AES-256加密，防止破解
✅ **易于管理** - 图形化工具，操作简单

**适用场景:**
- 商业软件授权分发
- 内部工具定向发布
- 付费软件销售
- 企业内部系统部署

---

**版本:** v1.0
**更新日期:** 2025-12-25
**作者:** Claude AI
