# 时效性验证功能说明 v2.0

本文档说明如何使用带时效性验证的密钥系统，实现试用版、月卡、年卡等多种授权模式。

---

## 🆕 新增功能

### V2.0 版本特性

✅ **时效性验证**
- 支持1天、7天、30天、90天、365天等预设有效期
- 支持自定义有效期天数
- 支持永久有效密钥

✅ **首次激活机制**
- 从用户首次使用开始计时
- 自动记录首次激活时间
- 防止提前激活

✅ **有效期管理**
- 实时显示剩余天数
- 有效期不足7天时自动提醒
- 支持密钥续期延长

✅ **过期检测**
- 每次启动自动检查有效期
- 过期后拒绝启动
- 清晰的过期提示信息

---

## 📊 时效性验证原理

### 工作流程

```
密钥生成时:
┌─────────────────────────────────────────────────────────┐
│ 主密钥 + 用户ID + 有效期 + 随机盐 → SHA256 → 64位密钥   │
│ 密钥格式: [60位哈希] + [4位有效期指纹]                   │
└─────────────────────────────────────────────────────────┘

首次使用时:
┌─────────────────────────────────────────────────────────┐
│ 1. 解析密钥中的有效期信息 (如: 30天)                    │
│ 2. 记录首次激活时间戳                                   │
│ 3. 计算过期时间 = 首次激活 + 有效期                     │
│ 4. 保存到本地激活文件 (activation.dat)                  │
└─────────────────────────────────────────────────────────┘

每次启动时:
┌─────────────────────────────────────────────────────────┐
│ 1. 读取激活记录                                         │
│ 2. 比较当前时间 vs 过期时间                             │
│ 3. 判断: 有效 → 显示剩余天数 → 允许启动                 │
│         过期 → 显示过期信息 → 拒绝启动                  │
└─────────────────────────────────────────────────────────┘
```

### 密钥格式说明

**64位密钥结构:**
```
[前60位: 主哈希值] + [后4位: 有效期指纹]

示例:
a1b2c3d4e5f6....(60位)....c7f8  ← 有效期指纹
└──────────┬──────────┘    └┬─┘
      主密钥哈希          有效期标识

有效期指纹对照:
- "0000" → 永久有效
- MD5("1")[:4] → 1天
- MD5("7")[:4] → 7天
- MD5("30")[:4] → 30天
- MD5("90")[:4] → 90天
- MD5("365")[:4] → 365天
```

---

## 🚀 管理员使用指南

### 1. 生成带时效性的密钥

```bash
cd tools
python generate_keys_v2.py
```

**操作示例:**

```
请输入主密钥文件路径: program_master.key

请选择操作: 1

--- 生成单个用户密钥 ---
用户ID: USER001
用户姓名: 张三
备注信息: 月卡用户

请选择有效期:
1. 1天 (试用版)
2. 7天 (周卡)
3. 30天 (月卡)      ← 选择这个
4. 90天 (季卡)
5. 365天 (年卡)
6. 永久有效
7. 自定义天数

请输入选项 (1-7): 3

============================================================
[✓] 密钥生成成功!
============================================================
用户ID: USER001
用户名: 张三

激活密钥: a1b2c3d4e5f6....(60位)....c7f8
有效期: 30 天
过期时间: 2026-01-24 10:30:00

请将此密钥提供给用户
============================================================
```

### 2. 批量生成不同有效期的密钥

```bash
python generate_keys_v2.py
```

选择选项2，输入:
```
USER001,张三,1,试用用户          # 1天试用
USER002,李四,30,月卡用户         # 30天月卡
USER003,王五,365,年卡用户        # 365天年卡
USER004,赵六,0,永久用户           # 永久有效
(空行结束)
```

### 3. 查看密钥状态

选择选项3，可以看到所有密钥的有效期状态:

```
============================================================
已生成密钥数量: 4
============================================================

[1] 用户ID: USER001
    用户名: 张三
    密钥: a1b2c3d4...
    生成时间: 2025-12-25 10:00:00
    有效期: 1 天
    状态: ❌ 已过期 (2025-12-26 10:00:00)
    备注: 试用用户

[2] 用户ID: USER002
    用户名: 李四
    密钥: b2c3d4e5...
    生成时间: 2025-12-25 10:00:00
    有效期: 30 天
    状态: ✅ 有效 (还剩 25 天)
    过期时间: 2026-01-24 10:00:00
    备注: 月卡用户

[3] 用户ID: USER003
    用户名: 王五
    密钥: c3d4e5f6...
    生成时间: 2025-12-25 10:00:00
    有效期: 365 天
    状态: ✅ 有效 (还剩 360 天)
    过期时间: 2026-12-25 10:00:00
    备注: 年卡用户

[4] 用户ID: USER004
    用户名: 赵六
    密钥: d4e5f6g7...
    生成时间: 2025-12-25 10:00:00
    有效期: ♾️  永久有效
    备注: 永久用户
```

### 4. 延长密钥有效期

用户需要续费时:

```bash
python generate_keys_v2.py
```

选择选项5:
```
--- 延长密钥有效期 ---
用户ID: USER002
延长天数: 30

[✓] 已为用户 USER002 延长 30 天
[✓] 新的过期时间: 2026-02-23 10:00:00
```

### 5. 导出密钥清单

```bash
python generate_keys_v2.py
```

选择选项4，生成 `keys_export_v2.txt`:

```
================================================================================
用户激活密钥列表 (V2 - 支持时效性)
生成时间: 2025-12-25 10:00:00
================================================================================

用户ID: USER001
用户名: 张三
激活密钥: a1b2c3d4e5f6...
生成时间: 2025-12-25 10:00:00
有效期: 1 天
过期时间: 2025-12-26 10:00:00
备注: 试用用户
--------------------------------------------------------------------------------

用户ID: USER002
用户名: 李四
激活密钥: b2c3d4e5f6...
生成时间: 2025-12-25 10:00:00
有效期: 30 天
过期时间: 2026-01-24 10:00:00
备注: 月卡用户
--------------------------------------------------------------------------------
```

---

## 👤 用户使用体验

### 首次激活

1. 用户获取密钥: `a1b2c3d4e5f6...c7f8` (30天月卡)
2. 双击运行 `launcher_v2.exe`
3. 输入密钥，点击"验证并启动"

**界面显示:**
```
✅ 首次激活成功！有效期 30 天
```

程序正常启动

### 日常使用

用户在有效期内每次启动:

**界面显示:**
```
✅ 密钥有效，还剩 25 天
```

程序正常启动

### 有效期不足提醒

当剩余天数 ≤ 7天时:

**弹窗提醒:**
```
⚠️ 有效期提醒

您的密钥还剩 5 天有效期
请及时续期！

[确定]
```

用户可以选择:
- 继续使用（直到过期）
- 联系管理员续费

### 密钥过期

当密钥过期后启动:

**界面显示:**
```
❌ 密钥已过期
```

**弹窗提示:**
```
❌ 密钥已过期

密钥已过期 (过期时间: 2026-01-24 10:00:00)
请联系管理员续期

[确定]
```

程序拒绝启动

---

## 🔧 编译和分发

### 编译V2启动器

```bash
cd dist
pip install pyinstaller pycryptodome
pyinstaller --onefile --windowed --name=launcher_v2 launcher_v2.py
```

生成的 `launcher_v2.exe` 位于 `dist/dist/` 目录

### 分发文件清单

打包给用户:
```
用户安装包/
├── download.bat          # 下载脚本(同V1)
├── launcher_v2.exe       # V2启动器(支持时效性)
└── 使用说明_v2.txt       # 更新的说明文档
```

---

## 📋 授权模式建议

### 商业软件授权方案

**试用版**
- 有效期: 1-3天
- 用途: 让用户快速体验功能
- 转化: 试用后购买正式版

**周卡/月卡**
- 有效期: 7天/30天
- 用途: 短期项目、临时需求
- 优势: 价格低，易接受

**季卡/年卡**
- 有效期: 90天/365天
- 用途: 长期使用
- 优势: 性价比高，用户粘性强

**永久授权**
- 有效期: 无限期
- 用途: VIP用户、买断制
- 优势: 一次付费，终身使用

### 定价策略示例

```
试用版:    免费 (1天)
周卡:     ¥19 (7天)
月卡:     ¥49 (30天)
季卡:     ¥129 (90天)    ← 推荐 (性价比最高)
年卡:     ¥399 (365天)   ← 最优惠 (比月卡便宜67%)
永久版:    ¥999 (永久)
```

---

## 🔐 安全性增强

### 防止密钥分享

虽然时效性验证可以限制使用时间，但无法防止多人共用一个密钥。如需防止密钥分享，可以结合:

**1. 硬件绑定**
```python
# 在launcher_v2.py中添加
import uuid

def get_machine_id():
    return str(uuid.getnode())

def bind_to_machine(key_hash):
    machine_id = get_machine_id()
    combined = f"{key_hash}:{machine_id}"
    return hashlib.sha256(combined.encode()).hexdigest()
```

**2. 在线验证**
- 每次启动连接服务器验证
- 记录使用设备数量
- 限制同时在线设备数

**3. 使用次数限制**
```python
# 限制启动次数
MAX_ACTIVATIONS = 100  # 最多启动100次

def check_activation_count(key_hash):
    count = get_activation_count(key_hash)
    if count >= MAX_ACTIVATIONS:
        return False
    increment_activation_count(key_hash)
    return True
```

---

## 🆚 V1 vs V2 对比

| 特性 | V1 (基础版) | V2 (时效性版) |
|------|------------|--------------|
| 密钥验证 | ✅ | ✅ |
| AES-256加密 | ✅ | ✅ |
| 一人一码 | ✅ | ✅ |
| 时效性验证 | ❌ | ✅ |
| 首次激活机制 | ❌ | ✅ |
| 过期检测 | ❌ | ✅ |
| 剩余天数显示 | ❌ | ✅ |
| 密钥续期 | ❌ | ✅ |
| 有效期提醒 | ❌ | ✅ |
| 适用场景 | 永久授权 | 订阅制/试用 |

---

## 💡 最佳实践

### 管理员

1. **合理设置有效期**
   - 试用版不要太长（1-3天）
   - 正式版根据定价策略设置
   - 永久版慎重发放

2. **定期检查密钥状态**
   - 使用选项3查看所有密钥
   - 关注即将过期的密钥
   - 提前联系用户续费

3. **密钥数据库备份**
   - 定期备份 `user_keys_v2.json`
   - 防止数据丢失
   - 便于数据迁移

4. **续费管理**
   - 使用选项5延长有效期
   - 也可以重新生成新密钥
   - 记录续费历史

### 用户

1. **及时续费**
   - 注意有效期提醒
   - 不要等到过期才续费
   - 保存好续费后的新密钥

2. **保管密钥**
   - 不要分享给他人
   - 建议保存到密码管理器
   - 备份到安全位置

3. **联系管理员**
   - 密钥遗失时及时联系
   - 需要续费时提前沟通
   - 遇到问题说明详细情况

---

## 🔄 从V1迁移到V2

如果您已经在使用V1版本，迁移到V2很简单:

1. **保留原有工具**
   - V1和V2可以同时存在
   - 原有V1密钥继续有效

2. **新用户使用V2**
   - 新生成的密钥使用V2工具
   - 分发launcher_v2.exe

3. **逐步迁移**
   - 老用户密钥到期后换V2
   - 或提供V2升级密钥

---

## 📞 技术支持

如有问题，请查看:
- 完整文档: `README.md`
- 快速入门: `快速入门.md`
- 系统演示: `python DEMO.py`

---

**版本:** v2.0
**更新日期:** 2025-12-25
**特性:** 支持时效性验证、首次激活机制、密钥续期
